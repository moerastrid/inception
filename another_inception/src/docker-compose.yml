version: '3.9'

networks:
  inception:
    name: inception
    driver: bridge

volumes:
  database:
    name: database_volume
    driver: local
    driver_opts:
      type: none
      device: ~/data/database
      o: bind
  webfiles:
    name: webfiles_volume
    driver: local
    driver_opts:
      type: none
      device: ~/data/webfiles
      o: bind

services:
  db:
    build: ./MariaDB
    image: mariadb
    restart: always
    expose:
      - "3306"
    volumes:
      - database:/var/lib/mysql
    env_file:
      - .env
    networks:
      - inception
    tty : true

    # container_name: db
    # env_file: .env
    # build: ./MariaDB/
    # volumes: 
    #   - database:/data/database
    # # configs:
    # #   - source: mariadb_config
    # #     target: etc/my.cnf
    # networks:
    #   - inception
    # restart: on-failure
    # healthcheck:
    #   test: ["CMD", "mysqladmin", "ping", "-h" ,"localhost"]
    #   interval: 5s
    #   timeout: 1s
    #   retries: 5
    #   start_period: 30s

  wpphp:
    container_name: wpphp
    env_file: .env
    depends_on:
      - db
      # db:
        # condition: service_healthy
    build: ./WP_PHP
    volumes:
      - webfiles:/data/webfiles/
    # configs:
    #   - source: wpphp_config
    #     target: /data/webfiles/wp-config.php
    networks:
      - inception
    restart:  on-failure

  nginx:
    container_name: nginx
    depends_on:
      wpphp:
        condition: service_started
    build: ./NginX
    volumes:
      - webfiles:/data/webfiles
    # configs:
    #   - source: nginx_config
    #     target: /etc/nginx/nginx.conf
    ports:
      - 433:433
    networks:
      - inception
    restart:  on-failure

# configs:
#   mariadb_config:
#     file: ./MariaDB/mariadb.conf
#   nginx_config:
#     file: ./NginX/nginx.conf
#   wpphp_config:
#     file: ./WP_PHP/wp-config.php
